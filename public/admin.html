<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>ç®¡ç†å“¡é é¢</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
</head>
<body class="container py-4">
  <h1 class="mb-4">ğŸ” ç®¡ç†å“¡å¾Œå°</h1>
  <div id="loginSection" class="mb-4">
    <h4>ç™»å…¥ä»¥ç¹¼çºŒ</h4>
    <input type="password" id="adminPassword" placeholder="è¼¸å…¥ç®¡ç†å“¡å¯†ç¢¼" class="form-control mb-2" />
    <button class="btn btn-primary" onclick="login()">ç™»å…¥</button>
  </div>

  <div id="adminPanel" style="display:none;">
    <button class="btn btn-outline-danger mb-3" onclick="logout()">ç™»å‡º</button>

    <h4>ğŸ“¦ è£œè²¨ç®¡ç†</h4>
    <div id="restockList"></div>

    <h4 class="mt-5">ğŸ†• æ–°å¢å•†å“</h4>
    <form id="addProductForm" class="mb-3">
      <input type="text" name="name" placeholder="å•†å“åç¨±" required class="form-control mb-2">
      <input type="number" name="price" placeholder="åƒ¹æ ¼" required class="form-control mb-2">
      <input type="number" name="stock" placeholder="åˆå§‹åº«å­˜" required class="form-control mb-2">
      <button class="btn btn-success">æ–°å¢å•†å“</button>
    </form>

    <h4>ğŸ’° åƒ¹æ ¼ä¿®æ”¹</h4>
    <form id="updatePriceForm" class="mb-3">
      <select name="productId" id="priceProductSelect" class="form-select mb-2"></select>
      <input type="number" name="price" id="newPriceInput" placeholder="æ–°åƒ¹æ ¼" required class="form-control mb-2">
      <button class="btn btn-warning">ä¿®æ”¹åƒ¹æ ¼</button>
    </form>

    <h4>ğŸ—‘ï¸ åˆªé™¤å•†å“</h4>
    <form id="deleteProductForm" class="mb-3">
      <select name="productId" id="deleteProductSelect" class="form-select mb-2"></select>
      <button class="btn btn-danger">åˆªé™¤å•†å“</button>
    </form>

    <h4>ğŸ“œ è£œè²¨ç´€éŒ„</h4>
    <ul id="historyList" class="list-group"></ul>
  </div>

  <script>
    let currentProducts = [];

    function login() {
      const password = document.getElementById('adminPassword').value;
      fetch('/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ password })
      }).then(res => res.json()).then(data => {
        if (data.success) {
          document.getElementById('loginSection').style.display = 'none';
          document.getElementById('adminPanel').style.display = 'block';
          loadData();
        } else {
          alert("å¯†ç¢¼éŒ¯èª¤");
        }
      });
    }

    function logout() {
      location.href = '/logout';
    }

    function loadData() {
      fetch('/products').then(res => res.json()).then(products => {
        currentProducts = products;
        const restockList = document.getElementById('restockList');
        const priceSelect = document.getElementById('priceProductSelect');
        const deleteSelect = document.getElementById('deleteProductSelect');
        restockList.innerHTML = '';
        priceSelect.innerHTML = '';
        deleteSelect.innerHTML = '';

        products.forEach(p => {
          const form = document.createElement('form');
          form.className = "d-flex gap-2 mb-2";
          form.innerHTML = `
            <strong>${p.name}</strong>ï¼ˆ${p.stock} ä»¶ï¼‰
            <input type="number" name="qty" value="1" min="1" class="form-control" style="width: 80px;">
            <button class="btn btn-sm btn-success">è£œè²¨</button>
          `;
          form.onsubmit = e => {
            e.preventDefault();
            const qtyInput = form.querySelector('input[name="qty"]');
            const qty = parseInt(qtyInput.value);
            if (isNaN(qty) || qty <= 0) {
              alert("âŒ è£œè²¨æ•¸é‡å¿…é ˆç‚ºå¤§æ–¼ 0 çš„æ•´æ•¸ï¼");
              qtyInput.focus();
              return;
            }
            fetch('/restock', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ productId: p.id, quantity: qty })
            }).then(() => loadData());
          };
          restockList.appendChild(form);

          const opt1 = document.createElement('option');
          opt1.value = p.id;
          opt1.textContent = `${p.name}ï¼ˆç›®å‰ NT$${p.price}ï¼‰`;
          priceSelect.appendChild(opt1);

          const opt2 = document.createElement('option');
          opt2.value = p.id;
          opt2.textContent = p.name;
          deleteSelect.appendChild(opt2);
        });
      });

      fetch('/restock-history').then(res => res.json()).then(records => {
        const list = document.getElementById('historyList');
        list.innerHTML = '';
        records.slice().reverse().forEach(r => {
          const item = document.createElement('li');
          item.className = "list-group-item";
          item.textContent = `${r.time} - ${r.name} è£œè²¨ ${r.quantity} ä»¶`;
          list.appendChild(item);
        });
      });
    }

    document.getElementById('addProductForm').addEventListener('submit', function (e) {
      e.preventDefault();
      const formData = new FormData(this);
      const body = {
        name: formData.get('name'),
        price: formData.get('price'),
        stock: formData.get('stock')
      };
      fetch('/add-product', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      }).then(() => {
        this.reset();
        loadData();
      });
    });

    document.getElementById('updatePriceForm').addEventListener('submit', function (e) {
      e.preventDefault();
      const formData = new FormData(this);
      const body = {
        productId: formData.get('productId'),
        price: formData.get('price')
      };
      fetch('/update-price', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      }).then(res => res.json()).then(data => {
        alert(data.message);
        loadData();
      });
    });

    document.getElementById('deleteProductForm').addEventListener('submit', function (e) {
      e.preventDefault();
      const formData = new FormData(this);
      const productId = formData.get('productId');
      fetch('/delete-product', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ productId })
      })
      .then(res => res.json())
      .then(data => {
        alert(data.message);
        loadData();
      });
    });
  </script>
</body>
</html>
