<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>ç®¡ç†å“¡é é¢</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <style>
    :root{--pad:12px}
    body{padding-bottom:64px}
    .preview-img{max-width:150px;max-height:150px;margin-top:6px;display:none;border:1px solid #ddd;border-radius:6px}
    .order-card img{width:52px;height:52px;object-fit:cover;border-radius:.35rem}
    .order-card-finished{opacity:.88;border-color:#198754}
    .badge-finished{background:#198754}
    .sticky-top-xs{position:sticky;top:0;z-index:1020;background:#fff}

    /* âœ… æ©«å‘æ»‘å‹•çš„å³æ™‚è¨‚å–®åˆ— */
    .live-scroll{
      display:flex; gap:.75rem; overflow-x:auto; padding-bottom:.25rem;
      scroll-snap-type:x mandatory;
      -webkit-overflow-scrolling: touch;
    }
    .live-scroll::-webkit-scrollbar{height:8px}
    .live-scroll::-webkit-scrollbar-thumb{background:#cfcfcf;border-radius:8px}
    .order-card{
      flex:0 0 auto; min-width:320px; max-width:360px; scroll-snap-align:start;
    }

    @media (max-width:576px){
      h1{font-size:1.25rem}
      .card{border-radius:.75rem}
      .btn{padding:.55rem .75rem}
      .form-control,.form-select{padding:.55rem .65rem}
      .section-card .card-body{padding:var(--pad)}
      .grid-2-xs{display:grid;grid-template-columns:1fr 1fr;gap:.5rem}
      .stack-xs>*{margin-bottom:.5rem}
      .hide-xs{display:none}
      .order-card img{width:46px;height:46px}
      .order-card{min-width:280px;max-width:85vw}
    }
  </style>
</head>
<body class="container py-3">

  <!-- Header -->
  <div class="sticky-top-xs py-2 d-flex align-items-center justify-content-between">
    <h1 class="mb-0">ğŸ” ç®¡ç†å“¡å¾Œå°</h1>
    <div class="d-flex gap-2">
      <a class="btn btn-outline-secondary btn-sm" href="/">è¿”å›å‰å°</a>
      <button class="btn btn-outline-danger btn-sm hide-xs" onclick="logout()">ç™»å‡º</button>
    </div>
  </div>

  <!-- ç™»å…¥ -->
  <div id="loginSection" class="mb-3">
    <div class="card section-card">
      <div class="card-body">
        <h5 class="mb-2">ç™»å…¥ä»¥ç¹¼çºŒ</h5>
        <div class="d-flex gap-2 stack-xs">
          <input type="password" id="adminPassword" class="form-control" placeholder="è¼¸å…¥ç®¡ç†å“¡å¯†ç¢¼"/>
          <button class="btn btn-primary" onclick="login()">ç™»å…¥</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ä¸»æ§å° -->
  <div id="adminPanel" style="display:none">
    <div class="d-sm-none mb-3">
      <div class="grid-2-xs">
        <button class="btn btn-outline-danger" onclick="logout()">ç™»å‡º</button>
        <button class="btn btn-outline-secondary" data-bs-toggle="collapse" data-bs-target="#filterWrap">ç¯©é¸è¨‚å–®</button>
      </div>
    </div>

    <!-- è¨‚å–®ç¯©é¸ -->
    <div class="card section-card mb-3">
      <div class="card-body">
        <div class="d-flex align-items-center justify-content-between">
          <h5 class="mb-0">ğŸ” è¨‚å–®ç¯©é¸</h5>
          <button class="btn btn-sm btn-outline-secondary d-none d-sm-inline" data-bs-toggle="collapse" data-bs-target="#filterWrap">æ”¶åˆ</button>
        </div>
        <div id="filterWrap" class="collapse show mt-2">
          <form id="orderFilterForm" class="row g-2">
            <div class="col-6 col-sm-3"><input class="form-control" name="name" placeholder="å§“åé—œéµå­—"></div>
            <div class="col-6 col-sm-3"><input class="form-control" name="phone" placeholder="é›»è©±é—œéµå­—"></div>
            <div class="col-6 col-sm-3"><input type="date" class="form-control" name="start"></div>
            <div class="col-6 col-sm-3"><input type="date" class="form-control" name="end"></div>
            <div class="col-6 col-sm-3">
              <select class="form-select" name="completed">
                <option value="">å®Œæˆç‹€æ…‹</option><option value="false">æœªå®Œæˆ</option><option value="true">å·²å®Œæˆ</option>
              </select>
            </div>
            <div class="col-6 col-sm-3">
              <select class="form-select" name="sort">
                <option value="">æ’åº</option><option value="date">å–è²¨æ—¥(æ–°â†’èˆŠ)</option><option value="amount">é‡‘é¡(é«˜â†’ä½)</option>
              </select>
            </div>
            <div class="col-6 col-sm-3">
              <div class="form-check mt-1">
                <input class="form-check-input" type="checkbox" name="includeDetails" id="includeDetails" value="1">
                <label class="form-check-label" for="includeDetails">é¡¯ç¤ºæ˜ç´°</label>
              </div>
            </div>
            <div class="col-6 col-sm-3"><button class="btn btn-secondary w-100">æŸ¥è©¢</button></div>
          </form>
          <div id="filterResults" class="mt-2"></div>
        </div>
      </div>
    </div>

    <!-- å³æ™‚è¨‚å–®ï¼ˆæ©«å‘æ»‘å‹•ï¼‰ -->
    <div class="card section-card mb-3">
      <div class="card-body">
        <div class="d-flex align-items-center justify-content-between">
          <h5 class="mb-2">ğŸ“¬ å³æ™‚è¨‚å–®</h5>
          <small id="sseStatus" class="text-muted">å³æ™‚è¨‚å–®ï¼šé€£ç·šä¸­â€¦</small>
        </div>
        <div id="liveOrders" class="live-scroll"></div>
      </div>
    </div>

    <!-- è£œè²¨ç®¡ç† -->
    <div class="card section-card mb-3">
      <div class="card-body">
        <h5 class="mb-2">ğŸ“¦ è£œè²¨ç®¡ç†</h5>
        <div id="restockList"></div>
      </div>
    </div>

    <!-- æ–°å¢å•†å“ -->
    <div class="card section-card mb-3">
      <div class="card-body">
        <h5 class="mb-2">ğŸ†• æ–°å¢å•†å“</h5>
        <form id="addProductForm" enctype="multipart/form-data">
          <input name="name" class="form-control mb-2" placeholder="å•†å“åç¨±" required>
          <div class="row g-2">
            <div class="col-6"><input name="price" type="number" class="form-control" placeholder="åƒ¹æ ¼" required></div>
            <div class="col-6"><input name="stock" type="number" class="form-control" placeholder="åˆå§‹åº«å­˜" required></div>
          </div>
          <input name="tags" class="form-control my-2" placeholder="æ¨™ç±¤ï¼ˆä»¥é€—è™Ÿåˆ†éš”ï¼‰">
          <input name="image" type="file" accept="image/*" class="form-control" onchange="previewImage(this,'addPreview')">
          <img id="addPreview" class="preview-img" alt="é è¦½">
          <button class="btn btn-success w-100 mt-2">æ–°å¢å•†å“</button>
        </form>
      </div>
    </div>

    <!-- æ›´æ›å•†å“åœ–ç‰‡ -->
    <div class="card section-card mb-3">
      <div class="card-body">
        <h5 class="mb-2">ğŸ–¼ï¸ æ›´æ›å•†å“åœ–ç‰‡</h5>
        <form id="updateImageForm" enctype="multipart/form-data">
          <select name="productId" id="imageProductSelect" class="form-select mb-2"></select>
          <input name="image" type="file" accept="image/*" class="form-control" required onchange="previewImage(this,'updatePreview')">
          <img id="updatePreview" class="preview-img" alt="é è¦½">
          <button class="btn btn-info text-white w-100 mt-2">ä¸Šå‚³ä¸¦æ›´æ›</button>
        </form>
      </div>
    </div>

    <!-- åƒ¹æ ¼/åˆªé™¤ -->
    <div class="row g-3">
      <div class="col-12 col-sm-6">
        <div class="card section-card h-100">
          <div class="card-body">
            <h5 class="mb-2">ğŸ’° åƒ¹æ ¼ä¿®æ”¹</h5>
            <form id="updatePriceForm">
              <select name="productId" id="priceProductSelect" class="form-select mb-2"></select>
              <div class="d-flex gap-2">
                <input name="price" id="newPriceInput" type="number" class="form-control" placeholder="æ–°åƒ¹æ ¼" required>
                <button class="btn btn-warning">ä¿®æ”¹</button>
              </div>
            </form>
          </div>
        </div>
      </div>
      <div class="col-12 col-sm-6">
        <div class="card section-card h-100">
          <div class="card-body">
            <h5 class="mb-2">ğŸ—‘ï¸ åˆªé™¤å•†å“</h5>
            <form id="deleteProductForm">
              <div class="d-flex gap-2">
                <select name="productId" id="deleteProductSelect" class="form-select"></select>
                <button class="btn btn-danger">åˆªé™¤</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- è£œè²¨ç´€éŒ„ -->
    <div class="card section-card my-3">
      <div class="card-body">
        <h5 class="mb-2">ğŸ“œ è£œè²¨ç´€éŒ„</h5>
        <ul id="historyList" class="list-group"></ul>
      </div>
    </div>
  </div>

  <script>
    let currentProducts=[], es;
    const $ = s => document.querySelector(s);

    function previewImage(input,id){
      const f=input.files?.[0],img=document.getElementById(id);
      if(!f){img.style.display='none';img.src='';return}
      const r=new FileReader(); r.onload=e=>{img.src=e.target.result;img.style.display='block'}; r.readAsDataURL(f);
    }
    const escapeHtml=s=>String(s||'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));

    function login(){
      fetch('/login',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({password:$('#adminPassword').value})})
      .then(r=>r.json()).then(d=>{
        if(!d.success) return alert('å¯†ç¢¼éŒ¯èª¤');
        $('#loginSection').style.display='none'; $('#adminPanel').style.display='block';
        loadData(); connectOrderStream();
      });
    }
    function logout(){ if(es) es.close(); location.href='/logout' }

    function loadData(){
      fetch('/products').then(r=>r.json()).then(ps=>{
        currentProducts=ps;
        const restock=$('#restockList'), priceSel=$('#priceProductSelect'), delSel=$('#deleteProductSelect'), imgSel=$('#imageProductSelect');
        restock.innerHTML=''; priceSel.innerHTML=''; delSel.innerHTML=''; imgSel.innerHTML='';

        ps.forEach(p=>{
          const f=document.createElement('form'); f.className='d-flex gap-2 align-items-center mb-2';
          f.innerHTML=`
            <strong class="me-1">${escapeHtml(p.name)}</strong>
            <span class="text-secondary">ï¼ˆ${p.stock} ä»¶${p.outOfStock?'ï½œç¼ºè²¨':''}ï¼‰</span>
            <input name="qty" type="number" value="1" min="1" class="form-control" style="max-width:96px">
            <button class="btn btn-sm btn-success">è£œè²¨</button>`;
          f.onsubmit=e=>{e.preventDefault(); const q=+f.qty.value||0;
            if(q<=0) return alert('âŒ è£œè²¨æ•¸é‡éœ€ç‚ºæ­£æ•´æ•¸');
            fetch('/restock',{
              method:'POST',headers:{'Content-Type':'application/json'},
              body:JSON.stringify({productId:p._id,quantity:q})
            }).then(()=>loadData());
          };
          restock.appendChild(f);

          [[priceSel,`${p.name}ï¼ˆNT$${p.price}ï¼‰`],[delSel,p.name],[imgSel,p.name]].forEach(([sel,txt])=>{
            const o=document.createElement('option'); o.value=p._id; o.textContent=txt; sel.appendChild(o);
          });
        });
      });

      fetch('/restock-history').then(r=>r.json()).then(rs=>{
        const list=$('#historyList'); list.innerHTML='';
        rs.slice().reverse().forEach(x=>{
          const li=document.createElement('li');
          li.className='list-group-item';
          li.textContent=`${x.time} - ${x.name} è£œè²¨ ${x.quantity} ä»¶`;
          list.appendChild(li);
        });
      });

      // åˆå§‹é¡¯ç¤ºæœ€è¿‘ 10 ç­†ï¼ˆæ©«å‘å¡ç‰‡ï¼‰
      fetch('/orders').then(r=>r.json()).then(all=>{
        const live=$('#liveOrders'); live.innerHTML='';
        all.slice(-10).reverse().forEach(o=>appendOrderCard(o));
      });
    }

    function setSseStatus(msg, ok=true){
      const el=$('#sseStatus'); if(!el) return;
      el.textContent=`å³æ™‚è¨‚å–®ï¼š${msg}`;
      el.className=`${ok?'text-success':'text-danger'}`;
    }

    function connectOrderStream(){
      if(es) es.close();
      try{
        es=new EventSource('/admin/orders/stream');
        setSseStatus('é€£ç·šä¸­â€¦', true);

        es.addEventListener('hello', () => setSseStatus('å·²é€£ç·š', true));
        es.addEventListener('order', ev => { try{ appendOrderCard(JSON.parse(ev.data), true); }catch{} });

        es.onerror = () => {
          setSseStatus('é€£ç·šä¸­æ–·ï¼Œé‡è©¦ä¸­â€¦', false);
          es.close();
          setTimeout(connectOrderStream, 2500);
        };
      }catch{
        setSseStatus('åˆå§‹åŒ–å¤±æ•—', false);
      }
    }

    function appendOrderCard(order, prepend=false){
      const live=$('#liveOrders'),wrap=document.createElement('div');
      wrap.className='order-card card'+(order.completed?' order-card-finished':'');
      const lines=(order.itemsDetailed||[]).map(it=>`
        <div class="d-flex align-items-center gap-2 py-1">
          <img src="${it.image||''}" onerror="this.src='https://via.placeholder.com/56?text=No+Image'">
          <div class="flex-grow-1">
            <div>${escapeHtml(it.name||'')}</div>
            <small class="text-muted">x ${it.quantity}ã€€NT$${it.price||0}</small>
          </div>
        </div>`).join('');
      const badge=order.completed?`<span class="badge badge-finished ms-2">å·²å®Œæˆ</span>`:'';
      wrap.innerHTML=`
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <div class="d-flex align-items-center flex-wrap gap-1">
                <h6 class="mb-0">è¨‚å–® #${order._id}ï½œNT$${order.total}</h6>${badge}
              </div>
              <small class="text-muted">${new Date(order.createdAt||Date.now()).toLocaleString()}</small>
            </div>
            ${order.completed?'':`<button class="btn btn-sm btn-success" onclick="markCompleted('${order._id}',this)">å®Œæˆ</button>`}
          </div>
          <div class="mt-2">
            <small class="text-muted d-block">å§“åï½œé›»è©±ï½œå–è²¨ï¼š${escapeHtml(order.name)}ï½œ${escapeHtml(order.phone)}ï½œ${escapeHtml(order.pickupDate||'â€”')}</small>
            <small class="text-muted d-block">åœ°å€ï¼š${escapeHtml(order.address||'â€”')}</small>
            <small class="text-muted d-block">å‚™è¨»ï¼š${escapeHtml(order.note||'â€”')}</small>
          </div>
          <hr class="my-2"/>
          ${lines||'<div class="text-muted">ï¼ˆç„¡æ˜ç´°ï¼‰</div>'}
        </div>`;
      if(prepend && live.firstChild) live.prepend(wrap); else live.appendChild(wrap);
    }

    function markCompleted(id,btn){
      btn.disabled=true;
      fetch('/complete-order',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({orderId:id})
      })
      .then(r=>r.json()).then(d=>{
        if(!d.success){alert(d.message||'å¤±æ•—'); btn.disabled=false; return}
        btn.closest('.order-card').classList.add('order-card-finished'); btn.remove();
      });
    }

    // ç¯©é¸
    document.getElementById('orderFilterForm').addEventListener('submit',function(e){
      e.preventDefault();
      const fd=new FormData(this), params=new URLSearchParams(fd);
      fetch('/query-orders?'+params.toString()).then(r=>r.json()).then(rows=>{
        const box=$('#filterResults'); if(!rows.length){box.innerHTML='<div class="text-muted">ç„¡ç¬¦åˆçµæœ</div>';return}
        box.innerHTML=rows.map(o=>{
          const tag=o.completed?'<span class="badge bg-success ms-1">å®Œæˆ</span>':'';
          return `<div class="small border rounded p-2 mb-2">
            <div class="d-flex justify-content-between">
              <div>#${o._id}ï½œNT$${o.total} ${tag}</div>
              <div class="text-muted">${new Date(o.createdAt).toLocaleString()}</div>
            </div>
            <div class="text-muted">å§“åï¼š${escapeHtml(o.name)}ï½œé›»è©±ï¼š${escapeHtml(o.phone)}ï½œå–è²¨ï¼š${escapeHtml(o.pickupDate||'â€”')}</div>
          </div>`;
        }).join('');
      });
    });

    // è¡¨å–®æäº¤
    document.getElementById('addProductForm').addEventListener('submit',function(e){
      e.preventDefault(); const fd=new FormData(this);
      fetch('/add-product',{method:'POST',body:fd}).then(r=>r.json()).then(d=>{
        alert(d.message); this.reset(); document.getElementById('addPreview').style.display='none'; loadData();
      });
    });

    document.getElementById('updateImageForm').addEventListener('submit',function(e){
      e.preventDefault(); const fd=new FormData(this);
      fetch('/update-product-image',{method:'POST',body:fd}).then(r=>r.json()).then(d=>{
        alert(d.message); this.reset(); document.getElementById('updatePreview').style.display='none'; loadData();
      });
    });

    document.getElementById('updatePriceForm').addEventListener('submit',function(e){
      e.preventDefault(); const fd=new FormData(this);
      fetch('/update-price',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({productId:fd.get('productId'),price:fd.get('price')})
      }).then(r=>r.json()).then(d=>{alert(d.message); loadData();});
    });

    document.getElementById('deleteProductForm').addEventListener('submit',function(e){
      e.preventDefault(); const fd=new FormData(this);
      fetch('/delete-product',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({productId:fd.get('productId')})
      }).then(r=>r.json()).then(d=>{alert(d.message); loadData();});
    });
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
