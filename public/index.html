<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>蔡阿粿</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
</head>
<body class="container py-4">
  <h1 class="mb-4">🛒蔡阿粿</h1>

  <div id="productList" class="mb-4"></div>

  <h4>🛒 購物車</h4>
  <div id="cartArea" class="mb-4">
    <ul id="cartList" class="list-group mb-2"></ul>
    <p id="cartTotal">總金額：0 元</p>
    <button class="btn btn-sm btn-outline-danger mb-3" onclick="clearCart()">清空購物車</button>
  </div>

  <form id="orderForm">
    <h4>📋 填寫訂單資料</h4>
    <div class="mb-2"><input name="name" required class="form-control" placeholder="姓名"></div>
    <div class="mb-2"><input name="phone" required class="form-control" placeholder="電話"></div>
    <div class="mb-2">
      <select name="deliveryOption" id="deliveryOption" class="form-select" onchange="toggleAddress()">
        <option value="delivery">宅配</option>
        <option value="pickup">自取</option>
      </select>
    </div>
    <div class="mb-2" id="addressGroup">
      <input name="address" class="form-control" placeholder="地址">
    </div>
    <div class="mb-3">
      <label>📅 取貨日：</label>
      <input type="date" name="pickupDate" id="pickupDate" required class="form-control">
    </div>
    <div class="mb-3">
      <textarea name="note" class="form-control" placeholder="備註（例如：請幫我分開包裝）"></textarea>
    </div>
    <button type="submit" id="submitBtn" class="btn btn-primary">送出訂單</button>
  </form>

  <div id="orderSummary" class="mt-5" style="display:none">
    <h4>✅ 訂單已成立</h4>
    <div id="orderDetails" class="border p-3 rounded bg-light"></div>
    <button class="btn btn-success mt-3" onclick="window.location.href='/'">返回首頁</button>
  </div>

  <script>
    let products = [];
    let cart = [];

    function toggleAddress() {
      const option = document.getElementById('deliveryOption').value;
      const addressGroup = document.getElementById('addressGroup');
      const addressInput = addressGroup.querySelector('input');

      if (option === 'pickup') {
        addressGroup.style.display = 'none';
        addressInput.removeAttribute('required');
      } else {
        addressGroup.style.display = 'block';
        addressInput.setAttribute('required', 'required');
      }
    }

    function renderCart() {
      const cartList = document.getElementById('cartList');
      const totalEl = document.getElementById('cartTotal');
      cartList.innerHTML = '';
      let total = 0;

      cart.forEach((item, index) => {
        const li = document.createElement('li');
        li.className = 'list-group-item d-flex justify-content-between align-items-center';
        const subtotal = item.product.price * item.quantity;
        total += subtotal;
        li.innerHTML = `
          ${item.product.name} - ${item.quantity} 件 × ${item.product.price} 元 = ${subtotal} 元
          <div>
            <input type="number" min="1" max="${item.product.stock}" value="${item.quantity}"
              style="width:60px" onchange="updateQty(${index}, this.value)">
            <button class="btn btn-sm btn-danger" onclick="removeFromCart(${index})">移除</button>
          </div>
        `;
        cartList.appendChild(li);
      });

      totalEl.textContent = `總金額：${total} 元`;
    }

    function addToCart(id) {
      const product = products.find(p => p.id === id);
      const cartItem = cart.find(c => c.product.id === id);
      if (cartItem) {
        if (cartItem.quantity >= product.stock) {
          alert(`❌ ${product.name} 已達最大庫存數量（${product.stock} 件）`);
          return;
        }
        cartItem.quantity += 1;
      } else {
        if (product.stock <= 0) {
          alert(`❌ ${product.name} 庫存不足`);
          return;
        }
        cart.push({ product, quantity: 1 });
      }

      renderCart();
      alert("✅ 已加入購物車");
    }

    function updateQty(index, qty) {
      const product = cart[index].product;
      let n = parseInt(qty);
      if (n > product.stock) {
        alert(`❌ 超出「${product.name}」可購買庫存數量（${product.stock} 件）`);
        n = product.stock;
      }
      if (n < 1) n = 1;
      cart[index].quantity = n;
      renderCart();
    }

    function removeFromCart(index) {
      cart.splice(index, 1);
      renderCart();
    }

    function clearCart() {
      cart = [];
      renderCart();
    }

    document.getElementById('orderForm').addEventListener('submit', e => {
      e.preventDefault();
      const submitBtn = document.getElementById('submitBtn');
      submitBtn.disabled = true;

      if (cart.length === 0) {
        alert("請先選擇商品");
        submitBtn.disabled = false;
        return;
      }

      const form = e.target;
      const formData = new FormData(form);

      const name = formData.get('name').trim();
      if (!/^[\u4e00-\u9fa5]{2,}$/.test(name)) {
        alert("❌ 姓名格式錯誤，請輸入至少兩個中文字！");
        form.querySelector('input[name="name"]').focus();
        submitBtn.disabled = false;
        return;
      }

      let phone = formData.get('phone').trim();
      if (/^[0-9]{9}$/.test(phone)) {
        phone = '09' + phone;
      }
      if (!/^09[0-9]{8}$/.test(phone)) {
        alert("❌ 電話號碼格式錯誤，請輸入正確的手機號碼！");
        form.querySelector('input[name="phone"]').focus();
        submitBtn.disabled = false;
        return;
      }

      const deliveryOption = formData.get('deliveryOption');
      let address = deliveryOption === 'pickup' ? '自取' : formData.get('address').trim();
      if (deliveryOption === 'delivery' && address.length < 5) {
        alert("❌ 地址格式錯誤，請輸入完整地址（至少5字）！");
        form.querySelector('input[name="address"]').focus();
        submitBtn.disabled = false;
        return;
      }

      const pickupDate = formData.get('pickupDate');
      const note = formData.get('note').trim();
      const today = new Date().toISOString().split('T')[0];
      if (pickupDate < today) {
        alert("❌ 取貨日不能早於今天！");
        form.querySelector('input[name="pickupDate"]').focus();
        submitBtn.disabled = false;
        return;
      }

      const order = {
        name,
        phone,
        address,
        pickupDate,
        note,
        items: cart.map(c => ({
          productId: c.product.id,
          quantity: c.quantity
        }))
      };

      fetch('/order', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(order)
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          document.getElementById('orderForm').style.display = 'none';
          document.getElementById('orderSummary').style.display = 'block';
          const details = document.getElementById('orderDetails');
          let summary = `
            <p><strong>姓名：</strong>${name}</p>
            <p><strong>電話：</strong>${phone}</p>
            <p><strong>地址：</strong>${address}</p>
            <p><strong>取貨日：</strong>${pickupDate}</p>
            <p><strong>備註：</strong>${note || '無'}</p>
            <hr><ul class="list-group mb-2">
          `;
          let total = 0;
          cart.forEach(item => {
            const subtotal = item.quantity * item.product.price;
            total += subtotal;
            summary += `<li class="list-group-item">${item.product.name} × ${item.quantity} 件 = NT$${subtotal}</li>`;
          });
          summary += `</ul><p><strong>總金額：</strong>NT$${total}</p>`;
          details.innerHTML = summary;
          clearCart();
        } else {
          alert("❌ 訂單失敗：\n" + data.message);
          submitBtn.disabled = false;
        }
      })
      .catch(() => {
        alert("❌ 系統錯誤，請稍後再試！");
        submitBtn.disabled = false;
      });
    });

    fetch('/products')
      .then(res => res.json())
      .then(data => {
        products = data;
        const list = document.getElementById('productList');
        list.innerHTML = '';
        data.forEach(p => {
          const div = document.createElement('div');
          div.className = 'border p-3 mb-3 rounded';
          div.innerHTML = `
            <div class="d-flex">
              <img src="images/${p.image || 'default.jpg'}" width="100" height="100" class="me-3" alt="${p.name}">
              <div>
                <h5>${p.name}</h5>
                <p>價格：NT$${p.price}｜庫存：${p.stock}</p>
                <p>標籤：${(p.tags || []).join(', ')}</p>
                <button class="btn btn-sm btn-success" onclick="addToCart(${p.id})">加入購物車</button>
              </div>
            </div>
          `;
          list.appendChild(div);
        });
      });

    window.onload = () => {
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('pickupDate').setAttribute('min', today);
      toggleAddress();
    };
  </script>
</body>
</html>
