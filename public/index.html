<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>è”¡é˜¿ç²¿</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <style>
    body { font-size: 1.2rem; }
    h1, h4 { font-weight: bold; }
    .product-img { width: 220px; height: 220px; object-fit: cover; border-radius: 10px; }
    .price-stock { font-size: 1.5rem; font-weight: bold; color: #b22222; }
    .meta { font-size: 1.2rem; color: #555; }
    .btn-full { width: 100%; font-size: 1.3rem; }
    #orderSummary.only-summary { margin-top: 32px; }
    .admin-btn { position: absolute; top: 15px; right: 15px; z-index: 1000; }
    /* toast å³ä¸Šè§’ */
    .toast-container { position: fixed; top: 16px; right: 16px; z-index: 2000; }
  </style>
</head>
<body class="container py-4">

  <!-- ç®¡ç†å“¡å¾Œå°æŒ‰éˆ• -->
  <a href="admin.html" class="btn btn-outline-dark admin-btn">ç®¡ç†å“¡å¾Œå°</a>

  <h1 id="pageTitle" class="mb-4 text-center">ğŸ›’ è”¡é˜¿ç²¿</h1>

  <div id="productList" class="mb-4"></div>

  <h4>ğŸ›’ è³¼ç‰©è»Š</h4>
  <div id="cartArea" class="mb-4">
    <ul id="cartList" class="list-group mb-2"></ul>
    <p id="cartTotal" class="fs-4 fw-bold">ç¸½é‡‘é¡ï¼š0 å…ƒ</p>
    <button class="btn btn-sm btn-outline-danger mb-3" onclick="clearCart()">æ¸…ç©ºè³¼ç‰©è»Š</button>
  </div>

  <form id="orderForm">
    <h4>ğŸ“‹ å¡«å¯«è¨‚å–®è³‡æ–™</h4>
    <div class="mb-2"><input name="name" required class="form-control" placeholder="å§“å"></div>
    <div class="mb-2"><input name="phone" required class="form-control" placeholder="é›»è©±"></div>
    <div class="mb-2">
      <select name="deliveryOption" id="deliveryOption" class="form-select" onchange="toggleAddress()">
        <option value="delivery">å®…é…</option>
        <option value="pickup">è‡ªå–</option>
      </select>
    </div>
    <div class="mb-2" id="addressGroup">
      <input name="address" class="form-control" placeholder="åœ°å€">
    </div>
    <div class="mb-3">
      <label>ğŸ“… å–è²¨æ—¥ï¼š</label>
      <input type="date" name="pickupDate" id="pickupDate" required class="form-control">
    </div>
    <div class="mb-3">
      <textarea name="note" class="form-control" placeholder="å‚™è¨»ï¼ˆä¾‹å¦‚ï¼šè«‹å¹«æˆ‘åˆ†é–‹åŒ…è£ï¼‰"></textarea>
    </div>
    <button type="submit" id="submitBtn" class="btn btn-primary btn-lg w-100">é€å‡ºè¨‚å–®</button>
  </form>

  <!-- âœ… æˆåŠŸæ‘˜è¦ï¼ˆé è¨­éš±è—ï¼‰ -->
  <div id="orderSummary" class="mt-5" style="display:none">
    <h4>âœ… è¨‚å–®å·²æˆç«‹</h4>
    <div id="orderDetails" class="border p-3 rounded bg-light"></div>
    <button class="btn btn-success mt-3 w-100" onclick="window.location.href='/'">è¿”å›é¦–é </button>
  </div>

  <!-- âœ… å³ä¸Šè§’æç¤º Toast -->
  <div class="toast-container">
    <div id="addedToast" class="toast text-bg-success align-items-center" role="status" aria-live="polite" aria-atomic="true" data-bs-delay="1400">
      <div class="d-flex">
        <div class="toast-body">âœ… å·²åŠ å…¥è³¼ç‰©è»Š</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    </div>
  </div>

  <script>
    let products = []; // å¾å¾Œç«¯ /products å–å¾—ï¼Œæ³¨æ„å«æœ‰ _id
    let cart = [];

    const addedToast = () => {
      const el = document.getElementById('addedToast');
      const toast = bootstrap.Toast.getOrCreateInstance(el);
      toast.show();
    };

    function toggleAddress() {
      const option = document.getElementById('deliveryOption').value;
      const addressGroup = document.getElementById('addressGroup');
      const addressInput = addressGroup.querySelector('input');
      if (option === 'pickup') {
        addressGroup.style.display = 'none';
        addressInput.removeAttribute('required');
      } else {
        addressGroup.style.display = 'block';
        addressInput.setAttribute('required', 'required');
      }
    }

    function renderCart() {
      const cartList = document.getElementById('cartList');
      const totalEl = document.getElementById('cartTotal');
      cartList.innerHTML = '';
      let total = 0;

      cart.forEach((item, index) => {
        const subtotal = item.product.price * item.quantity;
        total += subtotal;
        const li = document.createElement('li');
        li.className = 'list-group-item d-flex justify-content-between align-items-center';
        li.innerHTML = `
          <span class="fw-bold">${item.product.name}</span> - ${item.quantity} ä»¶ Ã— NT$${item.product.price} =
          <span class="text-danger fw-bold">NT$${subtotal}</span>
          <div class="d-flex gap-2 align-items-center">
            <input type="number" min="1" max="${item.product.stock}" value="${item.quantity}"
              style="width:70px" onchange="updateQty(${index}, this.value)">
            <button class="btn btn-sm btn-danger" onclick="removeFromCart(${index})">ç§»é™¤</button>
          </div>
        `;
        cartList.appendChild(li);
      });

      totalEl.textContent = `ç¸½é‡‘é¡ï¼š${total} å…ƒ`;
    }

    // â¬‡ï¸ é€™è£¡é‡è¦ï¼šæ”¹æˆä½¿ç”¨ _id
    function addToCart(id) {
      const product = products.find(p => p._id === id);
      if (!product || product.outOfStock || product.stock <= 0) {
        alert(`âŒ ${product ? product.name : 'å•†å“'} å·²ç¼ºè²¨`);
        return;
      }
      const cartItem = cart.find(c => c.product._id === id);
      if (cartItem) {
        if (cartItem.quantity >= product.stock) {
          alert(`âŒ ${product.name} å·²é”æœ€å¤§åº«å­˜ï¼ˆ${product.stock} ä»¶ï¼‰`);
          return;
        }
        cartItem.quantity += 1;
      } else {
        cart.push({ product, quantity: 1 });
      }
      renderCart();
      addedToast();
    }

    function updateQty(index, qty) {
      const product = cart[index].product;
      let n = parseInt(qty);
      if (n > product.stock) n = product.stock;
      if (n < 1) n = 1;
      cart[index].quantity = n;
      renderCart();
    }

    function removeFromCart(index) { cart.splice(index, 1); renderCart(); }
    function clearCart() { cart = []; renderCart(); }

    // âœ… åƒ…é¡¯ç¤ºæˆåŠŸæ‘˜è¦
    function showOnlySummary() {
      ['pageTitle', 'productList', 'cartArea', 'orderForm'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.style.display = 'none';
      });
      const summary = document.getElementById('orderSummary');
      summary.style.display = 'block';
      summary.classList.add('only-summary');
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // é€å–®
    document.getElementById('orderForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const submitBtn = document.getElementById('submitBtn');
      submitBtn.disabled = true;

      if (cart.length === 0) {
        alert("è«‹å…ˆé¸æ“‡å•†å“");
        submitBtn.disabled = false;
        return;
      }

      const form = e.target;
      const formData = new FormData(form);

      // å§“åï¼ˆè‡³å°‘å…©å€‹ä¸­æ–‡å­—ï¼‰
      const name = formData.get('name').trim();
      if (!/^[\u4e00-\u9fa5]{2,}$/.test(name)) {
        alert("âŒ å§“åæ ¼å¼éŒ¯èª¤ï¼Œè«‹è¼¸å…¥è‡³å°‘å…©å€‹ä¸­æ–‡å­—ï¼");
        form.querySelector('input[name="name"]').focus();
        submitBtn.disabled = false;
        return;
      }

      // é›»è©±ï¼ˆ09XXXXXXXXï¼‰
      let phone = formData.get('phone').trim();
      if (/^[0-9]{9}$/.test(phone)) phone = '09' + phone;
      if (!/^09[0-9]{8}$/.test(phone)) {
        alert("âŒ é›»è©±è™Ÿç¢¼æ ¼å¼éŒ¯èª¤ï¼Œè«‹è¼¸å…¥æ­£ç¢ºçš„æ‰‹æ©Ÿè™Ÿç¢¼ï¼");
        form.querySelector('input[name="phone"]').focus();
        submitBtn.disabled = false;
        return;
      }

      // åœ°å€ï¼ˆå®…é…æ™‚å¿…å¡«ä¸”é•·åº¦>=5ï¼Œç°¡å–®é˜²å‘†ï¼‰
      const deliveryOption = formData.get('deliveryOption');
      let address = deliveryOption === 'pickup' ? 'è‡ªå–' : formData.get('address').trim();
      if (deliveryOption === 'delivery') {
        if (address.length < 5) {
          alert("âŒ åœ°å€æ ¼å¼éŒ¯èª¤ï¼Œè«‹è¼¸å…¥å®Œæ•´åœ°å€ï¼ˆè‡³å°‘5å­—ï¼‰ï¼");
          form.querySelector('input[name="address"]').focus();
          submitBtn.disabled = false;
          return;
        }
        const keyHints = ['å¸‚','å€','é„‰','é®','è·¯','è¡—','å··','å¼„','è™Ÿ'];
        const hit = keyHints.filter(k => address.includes(k)).length;
        if (hit < 2) {
          if (!confirm('åœ°å€çœ‹èµ·ä¾†å¯èƒ½ä¸å®Œæ•´ï¼Œä»è¦é€å‡ºå—ï¼Ÿ')) {
            form.querySelector('input[name="address"]').focus();
            submitBtn.disabled = false;
            return;
          }
        }
      }

      // å–è²¨æ—¥ï¼ˆä¸å¯æ—©æ–¼ä»Šå¤©ï¼‰
      const pickupDate = formData.get('pickupDate');
      const note = (formData.get('note') || '').trim();
      const today = new Date().toISOString().split('T')[0];
      if (pickupDate < today) {
        alert("âŒ å–è²¨æ—¥ä¸èƒ½æ—©æ–¼ä»Šå¤©ï¼");
        form.querySelector('input[name="pickupDate"]').focus();
        submitBtn.disabled = false;
        return;
      }

      const order = {
        name,
        phone,
        address,
        pickupDate,
        note,
        // â¬‡ï¸ å‚³ _id çµ¦å¾Œç«¯
        items: cart.map(c => ({ productId: c.product._id, quantity: c.quantity }))
      };

      try {
        const res = await fetch('/order', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(order)
        });
        const data = await res.json();

        if (data.success) {
          // çµ„æˆåŠŸæ‘˜è¦ï¼ˆåªé¡¯ç¤ºä½ è¦çš„å€å¡Šï¼‰
          const details = document.getElementById('orderDetails');
          let summary = `
            <p><strong>å§“åï¼š</strong>${name}</p>
            <p><strong>é›»è©±ï¼š</strong>${phone}</p>
            <p><strong>åœ°å€ï¼š</strong>${address}</p>
            <p><strong>å–è²¨æ—¥ï¼š</strong>${pickupDate}</p>
            <p><strong>å‚™è¨»ï¼š</strong>${note || 'ç„¡'}</p>
            <hr>
            <ul class="list-group mb-2">
          `;
          let total = 0;
          cart.forEach(item => {
            const sub = item.quantity * item.product.price;
            total += sub;
            summary += `<li class="list-group-item">${item.product.name} Ã— ${item.quantity} ä»¶ = NT$${sub}</li>`;
          });
          summary += `</ul><p><strong>ç¸½é‡‘é¡ï¼š</strong>NT$${total}</p>`;
          details.innerHTML = summary;

          // æ¸…ç©ºä¸¦åƒ…é¡¯ç¤ºæ‘˜è¦
          clearCart();
          showOnlySummary();
        } else {
          alert("âŒ è¨‚å–®å¤±æ•—ï¼š\n" + data.message);
          submitBtn.disabled = false;
        }
      } catch (err) {
        alert("âŒ ç³»çµ±éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ï¼");
        submitBtn.disabled = false;
      }
    });

    // è¼‰å…¥å•†å“ï¼ˆå¾Œç«¯å·²å›å‚³ Cloudinary çµ•å°åœ–ç‰‡é€£çµèˆ‡ç¼ºè²¨æ¨™è¨˜ï¼‰
    fetch('/products')
      .then(res => res.json())
      .then(data => {
        products = data;
        const list = document.getElementById('productList');
        list.innerHTML = '';
        data.forEach(p => {
          const div = document.createElement('div');
          div.className = 'border p-3 mb-3 rounded';
          div.innerHTML = `
            <div class="d-flex align-items-start">
              <img class="product-img me-3" src="${p.image || ''}" alt="${p.name}">
              <div class="flex-grow-1">
                <h5 class="fw-bold mb-2">${p.name}</h5>
                <div class="price-stock mb-1">
                  åƒ¹æ ¼ï¼šNT$${p.price}ï½œåº«å­˜ï¼š${p.stock}${p.outOfStock ? 'ï¼ˆç¼ºè²¨ä¸­ï¼‰' : ''}
                </div>
                <div class="meta mb-3">æ¨™ç±¤ï¼š${(p.tags || []).join(', ') || 'â€”'}</div>
                <button class="btn ${p.outOfStock ? 'btn-secondary' : 'btn-success'} btn-full"
                        ${p.outOfStock ? 'disabled' : ''} onclick="addToCart('${p._id}')">
                  ${p.outOfStock ? 'ç¼ºè²¨ä¸­' : 'åŠ å…¥è³¼ç‰©è»Š'}
                </button>
              </div>
            </div>
          `;
          list.appendChild(div);
        });
      });

    window.onload = () => {
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('pickupDate').setAttribute('min', today);
      toggleAddress();
    };
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
