<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>è¨‚å–®æŸ¥è©¢ç³»çµ±</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body class="container py-4">
  <h2 class="mb-4">ğŸ“‹ è¨‚å–®æŸ¥è©¢ç³»çµ±</h2>

  <form id="searchForm" class="row g-2 mb-4">
    <div class="col-md-3">
      <input type="text" name="name" class="form-control" placeholder="å§“å">
    </div>
    <div class="col-md-3">
      <input type="text" name="phone" class="form-control" placeholder="é›»è©±">
    </div>
    <div class="col-md-2">
      <input type="date" name="start" class="form-control">
    </div>
    <div class="col-md-2">
      <input type="date" name="end" class="form-control">
    </div>
    <div class="col-md-2 d-flex align-items-center">
      <select name="sort" class="form-select">
        <option value="">æ’åºæ–¹å¼</option>
        <option value="amount">é‡‘é¡é«˜â†’ä½</option>
        <option value="date">æœ€æ–°â†’æœ€èˆŠ</option>
      </select>
    </div>
    <div class="col-md-12">
      <div class="form-check">
        <input class="form-check-input" type="checkbox" id="todayOnly">
        <label class="form-check-label" for="todayOnly">åªé¡¯ç¤ºä»Šå¤©çš„è¨‚å–®</label>
      </div>
    </div>
    <div class="col-md-12">
      <button class="btn btn-primary">æŸ¥è©¢</button>
      <button type="button" class="btn btn-success" onclick="exportPDF()">åŒ¯å‡º PDF</button>
    </div>
  </form>

  <div id="results"></div>

  <script>
    async function exportPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      const results = document.querySelectorAll('.order-card');
      if (results.length === 0) return alert('æ²’æœ‰çµæœå¯åŒ¯å‡º');
      results.forEach((el, i) => {
        doc.text(el.textContent.trim(), 10, 10 + i * 20);
      });
      doc.save("è¨‚å–®æŸ¥è©¢çµæœ.pdf");
    }

    document.getElementById('searchForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      const formData = new FormData(this);
      const name = formData.get('name');
      const phone = formData.get('phone');
      const start = formData.get('start');
      const end = formData.get('end');
      const sort = formData.get('sort');
      const todayOnly = document.getElementById('todayOnly').checked;

      let url = `/query-orders?name=${name}&phone=${phone}&sort=${sort}`;
      if (todayOnly) {
        const today = new Date().toISOString().split('T')[0];
        url += `&start=${today}&end=${today}`;
      } else {
        if (start) url += `&start=${start}`;
        if (end) url += `&end=${end}`;
      }

      const res = await fetch(url);
      const data = await res.json();
      const container = document.getElementById('results');
      container.innerHTML = '';

      if (data.length === 0) {
        container.innerHTML = '<div class="alert alert-warning">âŒ æŸ¥ç„¡è¨‚å–®</div>';
        return;
      }

      data.forEach(order => {
        const div = document.createElement('div');
        div.className = 'order-card card mb-3';
        div.innerHTML = `
          <div class="card-body">
            <h5 class="card-title">è¨‚å–®ç·¨è™Ÿ #${order.id}</h5>
            <p>å§“åï¼š${order.name}ï½œé›»è©±ï¼š${order.phone}<br>
               åœ°å€ï¼š${order.address}ï½œå–è²¨æ—¥ï¼š${order.pickupDate}<br>
               é‡‘é¡ï¼š${order.total} å…ƒ<br>
               å•†å“ï¼š<ul>${order.items.map(i => `<li>${i.product.name} Ã— ${i.quantity}</li>`).join('')}</ul>
            </p>
          </div>
        `;
        container.appendChild(div);
      });
    });
  </script>
</body>
</html>
